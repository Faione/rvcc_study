<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>record_13 - rvcc notes</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="record_1.html"><strong aria-hidden="true">1.</strong> record_1</a></li><li class="chapter-item expanded "><a href="record_2.html"><strong aria-hidden="true">2.</strong> record_2</a></li><li class="chapter-item expanded "><a href="record_3.html"><strong aria-hidden="true">3.</strong> record_3</a></li><li class="chapter-item expanded "><a href="record_4.html"><strong aria-hidden="true">4.</strong> record_4</a></li><li class="chapter-item expanded "><a href="record_5.html"><strong aria-hidden="true">5.</strong> record_5</a></li><li class="chapter-item expanded "><a href="record_6.html"><strong aria-hidden="true">6.</strong> record_6</a></li><li class="chapter-item expanded "><a href="record_7.html"><strong aria-hidden="true">7.</strong> record_7</a></li><li class="chapter-item expanded "><a href="record_8.html"><strong aria-hidden="true">8.</strong> record_8</a></li><li class="chapter-item expanded "><a href="record_9.html"><strong aria-hidden="true">9.</strong> record_9</a></li><li class="chapter-item expanded "><a href="record_10.html"><strong aria-hidden="true">10.</strong> record_10</a></li><li class="chapter-item expanded "><a href="record_11.html"><strong aria-hidden="true">11.</strong> record_11</a></li><li class="chapter-item expanded "><a href="record_12.html"><strong aria-hidden="true">12.</strong> record_12</a></li><li class="chapter-item expanded "><a href="record_13.html" class="active"><strong aria-hidden="true">13.</strong> record_13</a></li><li class="chapter-item expanded "><a href="record_14.html"><strong aria-hidden="true">14.</strong> record_14</a></li><li class="chapter-item expanded "><a href="record_15.html"><strong aria-hidden="true">15.</strong> record_15</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">rvcc notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="从文件中读取代码"><a class="header" href="#从文件中读取代码">从文件中读取代码</a></h1>
<p>早期设计中，通过向tokenize传入字符串来启动编译流程，现在修改为传入文件路径，tokenize需要从文件中读取文本再开始编译流程，因此需要增加一个<code>read_file</code>函数，用来从文件中读取待编译的代码（文件包括标准输入）</p>
<blockquote>
<p>open_memstream会创建一个动态数组，并支持stream操作接口，在数组伸缩时变更堆上内存大小</p>
</blockquote>
<pre><code class="language-c">static char *read_file(char *path) {
  FILE *in;

  if (strcmp(path, &quot;-&quot;) == 0) {
    // 文件名为 &quot;-&quot; 时，从stdin读取文本
    in = stdin;
  } else {
    in = fopen(path, &quot;r&quot;);
    if (!in)
      error(&quot;can't open %s: %s&quot;, path, strerror(errno));
  }

  char *buf;
  size_t buf_len;
  // 创建out数据流，将in中的文本数据读取到流中
  // buf指针指向out中的数据，buf_len为数据长度
  FILE *out = open_memstream(&amp;buf, &amp;buf_len);

  // 使用 read_buf 作为中转，将数据从 in 读取到 out 中
  while (true) {
    char *read_buf[4096];
    int num_read = fread(read_buf, sizeof(char), sizeof(read_buf), in);
    if (num_read == 0)
      break;
    fwrite(read_buf, sizeof(char), num_read, out);
  }

  if (in != stdin)
    fclose(in);

  // 刷新写缓冲区，保证所有内容都写入到 out 中
  fflush(out);

  // 保证以 `\n` 结尾
  if (buf_len == 0 || buf[buf_len - 1] != '\n')
    fputc('\n', out);

  // 满足字符串以 `\0` 结尾的要求
  fputc('\0', out);

  return buf;
}
</code></pre>
<p>同时，由于文件的引入，需要在编译错误时，给出更明确的错误定位</p>
<pre><code class="language-c">// 指示错误出现的位置
// foo.c:10: x = y + 1;
//               ^ &lt;错误信息&gt;
static void verror_at(char *loc, char *fmt, va_list va) {
  char *start = loc, *end = loc;

  // 移动 line 到 loc 所在行的起始位置
  // CUR_INPUT是字符串的第一个字符
  while (CUR_INPUT &lt; start &amp;&amp; start[-1] != '\n')
    start--;

  // 计算行号
  // start 之前遇到 n 个 '\n'，意味着有 n 行
  // 而 start 位于第 n + 1 行
  int num_line = 1;
  for (char *p = CUR_INPUT; p &lt; start; p++) {
    if (*p == '\n')
      num_line++;
  }

  // filename:line
  // indent记录输出了多少个字符
  int indent = fprintf(stderr, &quot;%s:%d&quot;, CUR_FILENAME, num_line);
  // 输出存在错误的行到end为止的文本
  fprintf(stderr, &quot;%.*s\n&quot;, (int)(end - start), start);

  // 计算错误信息要添加的位点
  int pos = loc - start + indent;

  // %*s 将会打印 pos 长度的字符串，若参数不满足长度 pos ，则使用空格补全
  fprintf(stderr, &quot;%*s&quot;, pos, &quot;&quot;);
  // 指示符
  fprintf(stderr, &quot;^ &quot;);
  vfprintf(stderr, fmt, va);
  fprintf(stderr, &quot;\n&quot;);
  va_end(va);
}
</code></pre>
<h1 id="增加println函数"><a class="header" href="#增加println函数">增加Println函数</a></h1>
<p>封装 printf，仅仅为了方便</p>
<h1 id="支持--o-与---help"><a class="header" href="#支持--o-与---help">支持 -o 与 --help</a></h1>
<p><code>-o</code> 用以指示目标文件路径，<code>--help</code>用来显示帮助信息，而在代码中额外增加了参数解析的逻辑，并使用两个全局变量来保存解析结果</p>
<pre><code class="language-c">static char *OUTPUT_PATH;
static char *INPUT_PATH;

static void parse_args(int argc, char **argv) {
  for (int i = 1; i &lt; argc; i++) {
    // 解析 -h | --help
    if (!strcmp(argv[i], &quot;-h&quot;))
      usage(0);

    if (!strcmp(argv[i], &quot;--help&quot;))
      usage(0);

    // 解析 -o &lt;path&gt;
    if (!strcmp(argv[i], &quot;-o&quot;)) {
      // &lt;path&gt; 为空则报错
      if (!argv[++i])
        usage(1);
      OUTPUT_PATH = argv[i];
      continue;
    }

    // 解析 &lt;file&gt;
    if (argv[i][0] == '-' &amp;&amp; argv[i][1] != '\0')
      error(&quot;invalid argument: %s&quot;, argv[i]);

    INPUT_PATH = argv[i];
  }

  if (!INPUT_PATH)
    error(&quot;no input files&quot;);
}
</code></pre>
<p>同时，在codegen中也增加了输出到文件的选项，得益于对printf函数的封装，修改只需要围绕println函数进行</p>
<pre><code class="language-c">static void println(char *fmt, ...) {
  va_list va;

  // 初始化 va 变量，fmt是最后一个固定参数
  va_start(va, fmt);
  vfprintf(OUTPUT_FILE, fmt, va);
  // 清理 va 变量
  va_end(va);

  fprintf(OUTPUT_FILE, &quot;\n&quot;);
}
</code></pre>
<h1 id="支持注释"><a class="header" href="#支持注释">支持注释</a></h1>
<p>注释仅用于说明，不参与代码的实际编译，支持注释首先需要确定注释的类型，如用于多行代码的块注释与用于单行代码的行注释，前者需要匹配开始与结尾，后者则需要匹配开头与<code>\n</code>，C标准中分别使用<code>/* ... */</code> 与 <code>//</code> 来标识上述注释。</p>
<p>考虑到注释内容不参与实际编译，因此只需要再词法分析过程中找到响应标识，并去除对应代码文本即可</p>
<h2 id="词法分析"><a class="header" href="#词法分析">词法分析</a></h2>
<p>在读取文本的时候，跳过注释即可</p>
<ul>
<li>strstr函数能够在 haystack 字符串中寻找 needle 字符串的位置（起始指针），没有找到则返回NULL</li>
</ul>
<pre><code class="language-c">  while (*p) {
    // 跳过行注释
    if (starts_with(p, &quot;//&quot;)) {
      p += 2;
      while (*p != '\n')
        p++;
      continue;
    }

    // 跳过块注释
    if (starts_with(p, &quot;/*&quot;)) {
      // 在剩余字符串中寻找 &quot;*/&quot; 的位置
      char *q = strstr(p + 2, &quot;*/&quot;);
      if (!q)
        error_at(p, &quot;unclosed block comment&quot;);
      p = q + 2;
      continue;
    }
...
  }
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="record_12.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="record_14.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="record_12.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="record_14.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
